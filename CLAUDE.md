# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a React-based web UI for [netctrl-server](https://github.com/filanov/netctrl-server), a network cluster configuration management backend. The UI provides CRUD operations for managing cluster resources via the netctrl-server REST API.

## Development Commands

```bash
npm install          # Install dependencies
npm run dev          # Start dev server on http://localhost:3000
npm run build        # TypeScript compile + Vite production build
npm run preview      # Preview production build locally
npm run lint         # Run ESLint
```

## Architecture & Critical Patterns

### API Integration & Proto Contract

**CRITICAL**: The UI types MUST match the netctrl-server proto definitions. The source of truth is:
- Proto file: `https://github.com/filanov/netctrl-server/blob/master/api/proto/v1/cluster.proto`
- Types defined in: `src/types/cluster.ts`

**Current Cluster Schema** (matches proto):
```typescript
{
  id: string           // Auto-generated by server
  name: string         // Required
  description: string  // Optional
  createdAt: string    // ISO 8601 timestamp (camelCase from API)
  updatedAt: string    // ISO 8601 timestamp (camelCase from API)
}
```

**IMPORTANT**: The API returns camelCase field names (`createdAt`, `updatedAt`), NOT snake_case. This is different from the proto field names but matches the JSON gateway output.

### API Request Pattern

The API client uses a baseURL pattern that must be understood to avoid path duplication bugs:

```typescript
// src/api/client.ts
const apiClient = axios.create({
  baseURL: '/api',  // Base path for ALL requests
})

// src/api/clusters.ts
apiClient.get('/v1/clusters')  // Results in: /api/v1/clusters ✓
// WRONG: apiClient.get('/api/v1/clusters')  // Results in: /api/api/v1/clusters ✗
```

**Rule**: API endpoint paths in `src/api/clusters.ts` should NEVER include the `/api` prefix since it's already in the baseURL.

### Dev Server Proxy

The Vite dev server (port 3000) proxies `/api/*` requests to the backend (port 8080):

```typescript
// vite.config.ts
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true,
    },
  },
}
```

This means:
- Frontend URL: `http://localhost:3000/clusters` (React app)
- API endpoint: `http://localhost:3000/api/v1/clusters` → proxied to → `http://localhost:8080/api/v1/clusters`

### State Management

- **TanStack Query (React Query)**: Handles all server state, caching, and refetching
- Query keys follow pattern: `['clusters']` or `['clusters', id]`
- Mutations automatically invalidate queries using `queryClient.invalidateQueries()`
- **404 handling**: The `getAll` function treats 404 responses as empty arrays, not errors

### Form Handling

- **React Hook Form**: Manages form state and validation
- **Zod**: Schema validation via `@hookform/resolvers/zod`
- **Pattern**: ClusterForm handles both create and edit modes based on URL param presence

### Routing

Single-page app with client-side routing:
```
/ → redirect to /clusters
/clusters → ClusterList page
/clusters/new → ClusterForm (create mode)
/clusters/:id/edit → ClusterForm (edit mode)
```

## When Adding New API Resources

If the backend adds new proto definitions (e.g., `agent.proto`):

1. **Fetch the proto definition** from the netctrl-server repo (master branch)
2. **Create type definition** in `src/types/` matching the API response format (camelCase for JSON)
3. **Create API functions** in `src/api/` using paths WITHOUT `/api` prefix
4. **Add routes** in `src/App.tsx`
5. **Create page components** in `src/pages/`

## Testing Backend Connectivity

```bash
# Test backend directly
curl http://localhost:8080/api/v1/clusters

# Test through proxy
curl http://localhost:3000/api/v1/clusters

# Both should return identical JSON
```

## Deployment

The project includes:
- **Dockerfile**: Multi-stage build with Nginx
- **docker-compose.yml**: Container orchestration
- **nginx.conf**: Production proxy configuration

For production, edit `nginx.conf` to proxy `/api` requests to the actual backend server.

## Common Issues

### Issue: Duplicate API path (e.g., `/api/api/v1/clusters`)
**Cause**: Endpoint path in `src/api/clusters.ts` includes `/api` prefix
**Fix**: Remove `/api` from the path - the baseURL already includes it

### Issue: Type mismatch errors
**Cause**: Types don't match the actual API response
**Fix**: Verify against proto file and check if API uses camelCase vs snake_case

### Issue: Empty list shows as error
**Cause**: 404 response not handled
**Fix**: API functions should catch 404 and return empty array

### Issue: Form validation failing
**Cause**: Zod schema doesn't match Cluster type
**Fix**: Ensure schema in `src/types/cluster.ts` matches proto definition
